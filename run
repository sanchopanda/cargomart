from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import TimeoutException
import time
import gspread
from google.oauth2.service_account import Credentials

# Настройки Google Sheets
creds_path = 'C:/Users/Даниил/Desktop/Logist Pro/py/credentials.json'
spreadsheet_name = 'Logist Pro'
scopes = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive']

creds = Credentials.from_service_account_file(creds_path, scopes=scopes)
client = gspread.authorize(creds)
spreadsheet = client.open(spreadsheet_name)
worksheet = spreadsheet.sheet1

# Заголовки для Google Sheets
headers = ['Тип груза', 'Тип кузова', 'Дата', 'Загрузка', 'Выгрузка', 'Ставка', 'Фирма', 'Город', 'Телефон']
worksheet.append_row(headers)

# Настройки для Chrome
chrome_driver_path = "C:\\Users\\Даниил\\Desktop\\Logist Pro\\py\\chromedriver-win64\\chromedriver.exe"
chrome_options = Options()
#chrome_options.add_argument("--headless")  # Опционально: запуск без интерфейса

# Установка ChromeDriver
service = Service(executable_path=chrome_driver_path)
driver = webdriver.Chrome(service=service, options=chrome_options)

# Открытие страницы логина
driver.get("https://cargomart.ru/login")

# Установка таймаута
wait = WebDriverWait(driver, 10)

# Ожидание до 10 секунд, пока не появится поле логина
WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.NAME, "login")))

try:
    # Поиск поля логина
    login_input = wait.until(EC.presence_of_element_located((By.NAME, "login")))
    login_input.send_keys("a.ivanov@dsg-logist.ru")  # Введите ваш логин

    # Поиск поля пароля
    password_input = driver.find_element(By.NAME, "password")
    password_input.send_keys("quCBdj4z")  # Введите ваш пароль

    # Поиск кнопки входа
    submit_button = driver.find_element(By.CSS_SELECTOR, 'button[type="submit"]')
    submit_button.click()

    # Подождем немного, чтобы страница прогрузилась после авторизации
    time.sleep(5)

    # Переход на страницу с заявками
    driver.get("https://cargomart.ru/orders/active")

    # Парсинг заявок на странице
    orders = driver.find_elements(By.CSS_SELECTOR, "._ListRow_clickable_c9rxt_11")  # Найти заявки на странице

    for order in orders:
        order.click()
        time.sleep(2)

        # Парсинг данных внутри заявки
        cargo_type = driver.find_element(By.CSS_SELECTOR, 'span.mt-2').text
        body_type = driver.find_element(By.CSS_SELECTOR, 'div.truncate.mb-1.text-body-sm').text
        date = driver.find_element(By.CSS_SELECTOR, 'p.truncate.text-on-surface-variant').text
        loading = ', '.join([el.text for el in driver.find_elements(By.CSS_SELECTOR, 'div.flex.mt-2 div.flex.flex-col')])
        unloading = ', '.join([el.text for el in driver.find_elements(By.CSS_SELECTOR, 'div.flex.mt-4 div.flex.flex-col')])
        rate = driver.find_element(By.CSS_SELECTOR, 'span.flex.items-center').text
        company = driver.find_element(By.CSS_SELECTOR, 'a.link.cursor-pointer.text-body-sm').text
        city = driver.find_element(By.CSS_SELECTOR, 'span.text-body-lg.text-on-surface').text
        phone = driver.find_element(By.CSS_SELECTOR, 'div.text-on-surface-variant').text

        # Добавление данных в Google Sheets
        row = [cargo_type, body_type, date, loading, unloading, rate, company, city, phone]
        worksheet.append_row(row)

        # Возврат к списку заявок
        driver.back()
        time.sleep(2)

except TimeoutException:
    print("Не удалось найти элемент на странице.")
finally:
    driver.quit()
