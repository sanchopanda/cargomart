import requests
import json
import os

# Базовые настройки доступа
API_BASE_HOST = "https://testdev2.logistpro.su"
API_BASE_URL = f"{API_BASE_HOST}/api/v1/"
API_KEY = "cCwnQ8BxKCMlPsN7thVhdtou2PiJzZE46atEQwlehaQ="
LOGIN = "ext.customer.7@logistpro.su"
PASSWORD = "SY61kIX4v6Kk3K"

# Подготовка базовых заголовков для HTTP запросов
headers = {
    "Accept": "application/json",
    "Content-Type": "application/json",
    "X-ApiKey": API_KEY,
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36"
}

# Создание сессии для управления куками и заголовками
session = requests.Session()
session.headers.update(headers)

def main():
    # 1. Проверка доступа к API
    url = f"{API_BASE_URL}test/ping"
    print(f"1. Проверка доступа к API: {url}")
    response = session.get(url)
    if not response.ok:
        print("   >> API не доступен")
        return
    print("   >> есть доступ")

    # 2. Авторизация
    url = f"{API_BASE_URL}account/login"
    print(f"2. Авторизация: {url}")
    login_data = {"Login": LOGIN, "Password": PASSWORD}
    response = session.post(url, json=login_data)
    if not response.ok:
        print("   >> Авторизация не удалась")
        return
    print("   >> прошла успешно")

    # Сохраняем cookie в сессии
    cookie = response.cookies.get(".AspNet.ApplicationCookie")
    if not cookie:
        print("   >> [Error] cookie не установлена")
        return
    session.headers.update({"Cookie": f".AspNet.ApplicationCookie={cookie}"})
    print(f"   >> Cookie установлена: {cookie}")

    # 3. Получение справочников для создания запроса
    url = f"{API_BASE_URL}request"
    print(f"3. Получение справочников для создания запроса: {url}")
    response = session.get(url)
    if not response.ok:
        print(f"[Error] {response.status_code} {response.reason}")
        return

    requests_data = response.json()
    save_to_file("response.json", requests_data)
    
    ids = [item["Id"] for item in requests_data.get("Items", [])]
    for id in ids:
        fetch_request(id)

def fetch_request(id):
    url = f"{API_BASE_URL}request/{id}"
    response = session.get(url)
    if not response.ok:
        return
    request_data = response.json()
    save_request_to_file(id, request_data)

def save_request_to_file(id, request_data):
    dir_path = os.path.join(os.getcwd(), 'requests')
    if not os.path.exists(dir_path):
        os.makedirs(dir_path)
    file_path = os.path.join(dir_path, f"{id}.json")
    with open(file_path, 'w', encoding='utf-8') as f:
        json.dump(request_data, f, ensure_ascii=False, indent=2)
    print(f"Request saved to {file_path}")

def save_to_file(filename, data):
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    print(f"Response saved to {filename}")

if __name__ == "__main__":
    main()
